<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <script src="//d3js.org/d3.v3.min.js"></script>
    <script src="js/paper-core.min.js"></script>
    <script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
    <script src="js/500px.js"></script>
    <link rel="stylesheet" type="text/css" href="css/app.css">
    <link rel="stylesheet" type="text/css" href="css/foundation.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.3/normalize.css">
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.18.2/TweenMax.min.js"></script> -->
    <title>natie squeegee</title>
</head>

<body>
    <ul class="sub-nav menu" role="navigation" title="Filter Menu List">
        <li class="sub-nav-title">category</li>
        <li id="" class="category active"> <a>All</a></li>
        <li class="category" id="Food"> <a>Food</a></li>
        <li class="category" id="Travel"> <a>Travel</a></li>
        <li class="category" id="Street"> <a>Street</a></li>
        <li class="category" id="Nature"> <a>Nature</a></li>
        <li id="customField">
            <input id="custom" placeholder="custom..."></input>
            <!-- <div id="placeButton"></div> -->
            <!-- <input id="submit" type="submit"></input> -->
        </li>
        <li>
            <button id="toggle"> toggle hot/cold shower </button>
        </li>
    </ul>
    <div>
    </div>
    <div id="view"></div>
    <div id="squeegee">
        <!-- <img id="cursor" src= "cursor.png"></img> -->
        <!-- <div class="firefly"> -->
        <!-- <div class="wings big one"></div> -->
        <!-- </div> -->
    </div>
</body>
<script>
var svg = d3.select("div#view").append("svg").attr("id", "canvas");

//Config
var circleRadius = 100;
var blurAmount = 20;
var clipDelay = 200;
var mode = 0;
var img, svg, mask;
var clipDuration = 30000;
var clipEase = 'quad'; //quad and circle look good
// var prevPoint = new paper.Point(0,0);
var prevPoint = {
    "x": 0,
    "y": 0
};
var curPoint = {
    "x": 0,
    "y": 0
};
var cursorAngle;
var squeegee = $("#squeegee")

$("#toggle").click(function() {
    mode = 1 - mode;
    if (mode == 0) {
        clipDuration = 20000;
    } else {
        clipDuration = 5;
    }
});

var cursor = d3.select("body").append("svg").attr("id", "cursor")
console.log(cursor);

sqicon = cursor.append('svg:image')
            .attr({
                'xlink:href': "http://anniejiao.me/squeegee/css/cursor.png",
                width: 125,
                height: 51,
            })

//CLIP
var clips = svg.append('svg:defs')
    .append('svg:mask')
    .attr({
        id: 'mask'
    });

var addMask = function addMask(x, y, deg) {
    //To achieve the unblur effect, we add circles to the clip mask
    // var clip = clips.append('svg:circle')
    //     .attr({
    //         cx: x,
    //         cy: y,
    //         r: circleRadius,
    //         fill: '#ffffff',
    //         'class': 'clipCircle'
    //     });
    var clip = clips.append('svg:rect')
        .attr({
            width: 125,
            height: 60,
            fill: '#ffffff',
            'class': 'clipCircle',
            "transform": "translate("+ x + "," + y + ") rotate("+deg+")"
        });

    return clip;
};


$(".category").on("click", function() {
    // svg.html("");
    svg.selectAll("image").remove();

    $(".category").removeClass("active");
    $(this).addClass("active")
    var category = $(this).attr("id");
    getImage(category)
})

$("input").keyup(function(e) {
  svg.selectAll("image").remove();
    if (e.keyCode == 13) {
        svg.selectAll("image").remove();
        $(".category").removeClass("active");
        var category = $(this).val();
        searchImage(category);
    }
});

//Blur filter
var defs = svg.append('svg:defs');
var filterBlur = defs.append('svg:filter')
    .attr({
        id: 'blur'
    });
filterBlur.append('feGaussianBlur')
    .attr({
        'in': "SourceGraphic",
        'stdDeviation': blurAmount
    });

var enableHandler = true;

// timer = window.setInterval(function() {
//     enableHandler = true;
// }, 100);

var cursorAngle;
var mouseMove = function move(e) {
    
    //erase on mouse over
    if (enableHandler) {
        curPoint.x = d3.event.pageX
        curPoint.y = d3.event.pageY;

        dx = curPoint.x - prevPoint.x
        dy = curPoint.y - prevPoint.y

        var vector = new paper.Point(dx, dy);
        cursorAngle = vector.angle + 90;

        // TweenMax.to(sqicon, 0, {
        //     rotationZ: cursorAngle
        // });

        sqicon.attr("transform", "translate("+ curPoint.x + "," + curPoint.y + ") rotate("+cursorAngle+")");

        // sqicon.attr("transform", "translate("+ dx + "," + dy + ")");

//.attr("x", curPoint.x).attr("y", curPoint.y)
        // squeegee.css("left", curPoint.x);
        // squeegee.css("top", curPoint.y);
        // TweenMax.to(squeegee, 0.1, {x:curPoint.x-prevPoint.x, y:curPoint.y-prevPoint.y});
        // TweenMax.to(squeegee, 0, {
        //     left: curPoint.x,
        //     top: curPoint.y
        // });

        // prevPoint = curPoint;
        prevPoint.x = curPoint.x;
        prevPoint.y = curPoint.y;
        // enableHandler = false;

    }
    // var curPoint = new paper.Point(d3.event.pageX, d3.event.pageY);

    // var x = parseInt(d3.event.pageX - 25 + circleRadius / 2, 10);
    // var y = parseInt(d3.event.pageY - 25 - circleRadius, 10);

    //Add mask
    var clip = addMask(curPoint.x, curPoint.y, cursorAngle);

    clip.transition().ease(clipEase)
        .delay(clipDelay)
        .duration(clipDuration)
        .attr({
            fill: '#000000',
            r: 0
        })
        .each('end', function end() {
            this.remove();
        })
};

$(document).ready(function() {
    var imageUrl;
    _500px.init({
        sdk_key: 'ff6d61fac0e96e8c54f17f9bef8674230426f07e',
        "consumer_key": "toNzUXsgWhv6knJFYzFEaALwZyJosUTAAta9Rh3D"
    });

    getImage(" ");
    $(window).resize(resize);
    svg.on('mousemove', mouseMove);
    resize();
});

function getImage(category) {
    _500px.api('/photos', 'get', {
        rpp: 5,
        "feature": "editor",
        "image_size": "2048",
        "only": category,
        "exclude": "People, Nude"
    }, function(response) {
        handleResponse(response)
    });
}

function searchImage(term) {
    _500px.api('/photos/search', 'get', {
        rpp: 5,
        term: term,
        "feature": "editor",
        "image_size": "2048",
        "exclude": "People, Nude"
    }, function(response) {
        handleResponse(response);
    });
}

function handleResponse(response) {
    if (response.success) {
        var i = Math.floor(Math.random() * 5);
        imageUrl = response.data.photos[i].image_url;
        //Add blurred image
        img = svg.append('svg:image')
            .attr({
                x: 0,
                y: 0,
                filter: 'url(#blur)',
                'xlink:href': imageUrl,
                width: window.innerWidth,
                height: window.innerHeight,
                fill: '#336699'
            })

        //MASK
        //  Add masked image (regular, non blurred image which will be revealed
        mask = svg.append('svg:image')
            .attr({
                x: 0,
                y: 0,
                'xlink:href': imageUrl,
                'mask': 'url(#mask)',
                width: window.innerWidth,
                height: window.innerHeight,
                filter: 'url(#blur2)',
                fill: '#336699'
            });
    } else {
        console.log("failed")
    }
}

function resize() {
    width = window.innerWidth || e.clientWidth || g.clientWidth;;
    height = window.innerHeight || e.clientHeight || g.clientHeight;

    svg.attr("width", width).attr("height", height);
    img.attr("width", width).attr("height", height);
    mask.attr("width", width).attr("height", height);
}
</script>
