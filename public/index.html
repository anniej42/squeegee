<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <script src="//d3js.org/d3.v3.min.js"></script>
    <!-- <script src="paper-core.min.js"></script> -->
    <script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
    <script src="500px.js"></script>
    <!-- <script src="js/index.js"></script> -->
    <link rel="stylesheet" type="text/css" href="css/app.css">
    <link rel="stylesheet" type="text/css" href="scripts/semantic.min.css">
    <script src="scripts/semantic.min.js"></script>
    <title>natie squeegee</title>
</head>

<body>
    <div class="headerMenu">
        <div class="ui secondary menu">
            <div class="header item">CATEGORY</div>
            <a class="category active item" id="mildly_interesting"> ALL </a>
            <a class="category item" id="gourmet_food"> FOOD </a>
            <a class="category item" id="travel"> TRAVEL </a>
            <a class="category item" id="street_photography"> STREET </a>
            <a class="category item" id="majestic_landscapes"> NATURE </a>
            <div class="item ui search">
                <div id="customField" class="ui icon input">
                    <input id="custom" type="text" class="prompt" placeholder="Search...">
                    <i class="search icon"></i>
                </div>
            </div>
            <div class="right menu">
                <div class="ui item pageLink"> NATIE/LABS/SQUEEGEE </div>
            </div>
        </div>
        <div id="view"></div>
        <div id="squeegee"> </div>
</body>
<script>
var svg = d3.select("div#view").append("svg").attr("id", "canvas");

//Config
var circleRadius = 50;
var blurAmount = 20;
var clipDelay = 200;
var mode = 0;
var img, svg, mask;
var clipDuration = 30000;
var clipEase = 'quad'; //quad and circle look good
var imageUrl;
// var prevPoint = new paper.Point(0,0);
var prevPoint = {
    "x": 0,
    "y": 0
};
var curPoint = {
    "x": 0,
    "y": 0
};
var cursorAngle;
var squeegee = $("#squeegee")


var cursor = d3.select("body").append("svg").attr("id", "cursor");

var sqicon = cursor.append('svg:image')
    .attr({
        'xlink:href': "/css/cursor.png",
        width: 100,
        height: 40,
    })

function google(category) {
    category = category.replace("_", " ");
    $.post(
        window.location.origin + '/getURL', {
            "category": category
        },
        function(data) {
            // console.log(data);
            putImage(data);
        }
    );
}

//CLIP
var clips = svg.append('svg:defs')
    .append('svg:mask')
    .attr({
        id: 'mask'
    });

var addMask = function addMask(x, y, deg) {
    // circle blur
    var clip = clips.append('svg:circle')
        .attr({
            cx: x,
            cy: y,
            r: circleRadius,
            fill: '#ffffff',
            'class': 'clipCircle'
        });
    // var clip = clips.append('svg:rect')
    //     .attr({
    //         width: 125,
    //         height: 60,
    //         fill: '#ffffff',
    //         'class': 'clipCircle',
    //         "transform": "translate("+ x + "," + y + ") rotate("+deg+")"
    //     });

    return clip;
};


$(".category").on("click", function() {
    // svg.html("");
    svg.selectAll("image").remove();
    svg.selectAll(".clipCircle").remove();

    $(".category").removeClass("active");
    $(this).addClass("active")
    var category = $(this).attr("id");
    google(category)
})

$("input").keyup(function(e) {
    if (e.keyCode == 13) {
        svg.selectAll("image").remove();
        svg.selectAll(".clipCircle").remove();
        $(".category").removeClass("active");
        var category = $(this).val();
        google(category)
    }
});

//Blur filter
var defs = svg.append('svg:defs');
var filterBlur = defs.append('svg:filter')
    .attr({
        id: 'blur'
    });
filterBlur.append('feGaussianBlur')
    .attr({
        'in': "SourceGraphic",
        'stdDeviation': blurAmount
    });

var cursorAngle;
var rotateCounter = 0;
var mouseMove = function move(e) {
    rotateCounter = (rotateCounter + 1) % 18;

    //erase on mouse over
    curPoint.x = d3.event.pageX
    curPoint.y = d3.event.pageY;

    sqicon.attr("transform", "translate(" + curPoint.x + "," + curPoint.y + ") rotate(" + rotateCounter * 20 + ")");
    prevPoint.x = curPoint.x;
    prevPoint.y = curPoint.y;

    //Add mask
    var clip = addMask(curPoint.x, curPoint.y, cursorAngle);

    clip.transition().ease(clipEase)
        .delay(clipDelay)
        .duration(clipDuration)
        .attr({
            fill: '#000000',
            r: 0
        })
        .each('end', function end() {
            this.remove();
        })
};

$(document).ready(function() {
    google("mildly interesting");
    $(window).resize(resize);
    svg.on('mousemove', mouseMove);
    resize();
});

function handleResponse(response) {
    if (response.success) {
        var i = Math.floor(Math.random() * 5);
        imageUrl = response.data.photos[i].image_url;
        //Add blurred image
        img = svg.append('svg:image')
            .attr({
                x: 0,
                y: 0,
                filter: 'url(#blur)',
                'xlink:href': imageUrl,
                width: window.innerWidth,
                height: window.innerHeight,
                fill: '#336699'
            })

        //MASK
        //  Add masked image (regular, non blurred image which will be revealed
        mask = svg.append('svg:image')
            .attr({
                x: 0,
                y: 0,
                'xlink:href': imageUrl,
                'mask': 'url(#mask)',
                width: window.innerWidth,
                height: window.innerHeight,
                filter: 'url(#blur2)',
                fill: '#336699'
            });
    } else {
        console.log("failed")
    }
}

function putImage(url) {
    img = svg.append('svg:image')
        .attr({
            x: 0,
            y: 0,
            filter: 'url(#blur)',
            'xlink:href': url,
            width: window.innerWidth,
            height: window.innerHeight,
            fill: '#336699'
        })

    //MASK
    //  Add masked image (regular, non blurred image which will be revealed
    mask = svg.append('svg:image')
        .attr({
            x: 0,
            y: 0,
            'xlink:href': url,
            'mask': 'url(#mask)',
            width: window.innerWidth,
            height: window.innerHeight,
            filter: 'url(#blur2)',
            fill: '#336699'
        });
}


function resize() {
    var width = window.innerWidth || e.clientWidth || g.clientWidth;;
    var height = window.innerHeight || e.clientHeight || g.clientHeight;

    svg.attr("width", width).attr("height", height);
    img.attr("width", width).attr("height", height);
    mask.attr("width", width).attr("height", height);
}
</script>
